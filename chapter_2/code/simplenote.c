#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>     // Defines flags used in the open function
#include <sys/stat.h>  // Defines flags used in the open function
#include <unistd.h>    // Defines the open function
#include "functions.h"

void usage (char* progname, char* filename) {
    printf("Usage: %s <data to add to %s>\n", progname, filename);
    exit(0);
}


int main(int argc, char* argv[]){
    // Declare variables
    char* buffer = (char *) ec_malloc(100);
    char* datafile = (char *) ec_malloc(20);
    strcpy(datafile, "/var/notes");

    // Checks if incomplete args
    if (argc < 2) 
        usage(argv[0], datafile);

    strcpy(buffer, argv[1]);

    printf("[DEBUG] buffer   @ %p: '%s'\n", buffer, buffer);
    printf("[DEBUG] datafile @ %p: '%s'\n", datafile, datafile);

    // Opening file
    // O_RDONLY = read only
    // O_WRONLY = write only
    // O_RDWR = read and write
    //
    // O_APPEND = append to the end of the file
    // O_TRUNC = overwrite the file 
    // O_CREAT = Create the file if it doesnt exist
    //
    // Page 87
    // S_IRUSR = Gives read permission to the user
    // S_IWUSR = gives write permission to the user
    // You need these cuz you're using O_CREAT if the file does not exist
    int fd = open(datafile, O_WRONLY | O_CREAT | O_APPEND, S_IRUSR | S_IWUSR);

    // open(), write(), read(), close() all return -1 if there's something wrong
    if (fd == -1) // open returns -1 if there's something wrong
        fatal("in main() while opening a file");
    
    printf("[DEBUG] file descriptor is %d\n", fd);
    
    int userid = getuid();

    // Writing the userid
    if(write(fd, &userid, 4) == -1) 
        fatal("in main() writing the buffer to the file");
    write(fd, "\n", 1); 

    // Writing the buffer
    if(write(fd, buffer, strlen(buffer)) == -1) 
        fatal("in main() writing the buffer to the file");
    write(fd, "\n", 1);

    if(close(fd) == -1)
        fatal("in main() closing the file");

    printf("Note has been saved\n");
    free(buffer);
    free(datafile);
}

